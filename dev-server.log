
> gemini-ocr@0.1.0 dev
> next dev

   ‚ñ≤ Next.js 15.0.3
   - Local:        http://localhost:3000
   - Environments: .env.local

 ‚úì Starting...
 ‚úì Ready in 1658ms
 ‚óã Compiling /api/mobile/exam-questions ...
 ‚úì Compiled /api/mobile/exam-questions in 3.1s (898 modules)
‚è±Ô∏è  [TIMER] ExamGenie Mobile API Processing started at 2025-10-18T13:59:06.905Z
 POST /api/mobile/exam-questions 400 in 3332ms
‚è±Ô∏è  [TIMER] ExamGenie Mobile API Processing started at 2025-10-18T13:59:23.088Z
[RateLimiter] Initialized with limits: 10/hour, 50/day
[RateLimit] User test-local-user - Remaining: 9/10
[Auth] JWT provided: false, Source: body
=== IMAGE VALIDATION START ===
=== IMAGE VALIDATION PASSED ===
=== MOBILE API REQUEST DETAILS ===
Processing ID: 72c1aee0-7990-44fa-9bdf-33a127be7418
Image count: 1
Category: not specified
Subject: Historia
Grade: 5
User ID (final): test-local-user
User ID (from JWT): not provided
User ID (from body): test-local-user
Auth Method: Body
Language: en
Client IP: ::1
User Agent: curl/8.7.1
=== END REQUEST DETAILS ===
‚è±Ô∏è  [TIMER] ExamGenie Mobile API Processing started at 2025-10-18T13:59:23.093Z
=== EXAMGENIE MOBILE API ENDPOINT CALLED ===
Processing ID: 72c1aee0-7990-44fa-9bdf-33a127be7418
Category: not specified
Subject: Historia
Grade: 5
User ID: test-local-user
Language: en
‚è±Ô∏è  [TIMER] Starting File Processing
Processing 1 images:
  - Total size: 812.2 KB
  - Average size: 812.2 KB
  - MIME types: image/jpeg(1)
  Image 1: sivu12.jpeg (812.2 KB)
‚è±Ô∏è  [TIMER] File Processing completed: 2ms
Using prompt type: HISTORY(subject-Historia, grade-5)
=== FULL PROMPT SENT TO GEMINI ===
Create a history exam for grade 5 students based on educational material.

üéØ PRIMARY OBJECTIVE: Test understanding of the SPECIFIC historical content shown in the material.

‚ö†Ô∏è CRITICAL LANGUAGE REQUIREMENT:
- Use the SAME language as the source material
- Auto-detect the language from the textbook images
- ALL questions, options, explanations, and summary MUST be in the detected language
- Do NOT default to English if material is in another language (Finnish, Swedish, German, etc.)

CRITICAL RULES:
1. ‚úÖ Questions MUST focus on the MAIN TOPICS and EVENTS described in the material
2. ‚úÖ Questions MUST test comprehension of the SPECIFIC narrative/story presented
3. ‚úÖ Questions MUST be factually accurate (verify dates, names, events)
4. ‚ùå AVOID generic vocabulary/definition questions unless the term is central to understanding the topic
5. ‚ùå NEVER include facts not present in the source material
6. ‚ùå NEVER make assumptions about content not shown

CONTENT ANALYSIS FIRST:
Before generating questions, analyze the material:
- What is the main historical event/period/concept?
- What is the central narrative or story?
- Who are the main people/groups involved?
- What happened (chronological events)?
- When did it happen (dates/periods)?
- Why did it happen (causes)?
- What were the results/consequences?

QUESTION PRIORITY (focus on these in order):
1. **Main Events** (40%): What happened? Chronology, key turning points
2. **Causes & Consequences** (30%): Why did it happen? What resulted?
3. **Key Figures & Groups** (20%): Who was involved? What roles did they play?
4. **Context & Terms** (10%): Supporting vocabulary ONLY if central to understanding

FORBIDDEN QUESTION TYPES:
‚ùå Generic definitions not tied to the specific topic (e.g., "What is democracy?")
‚ùå Questions about concepts mentioned only briefly
‚ùå Historical facts NOT present in the material
‚ùå "Which of these is true?" questions without clear focus
‚ùå Questions requiring outside knowledge beyond the material
‚ùå References to visual elements (images, graphs, diagrams, page numbers)

GOOD QUESTION EXAMPLES:
‚úÖ "What were the main causes of [the event] according to the material?"
‚úÖ "Which groups/people were involved in [the event]?"
‚úÖ "When did [the event] take place?"
‚úÖ "What was the outcome of [the event]?"
‚úÖ "Why did [cause] lead to [consequence]?"
‚úÖ "How did [person/group] contribute to [event]?"

BAD QUESTION EXAMPLES:
‚ùå "What does 'democracy' mean?" (too generic unless central to the narrative)
‚ùå "What is a political system?" (generic definition)
‚ùå "What is international cooperation?" (not about the main topic)
‚ùå "What is the capital of [country]?" (random fact, not from material)

FACTUAL ACCURACY REQUIREMENTS:
Before finalizing EACH question:
‚ñ° Verify dates are correct
‚ñ° Verify names are spelled correctly
‚ñ° Verify cause-effect relationships are accurate
‚ñ° Verify the fact appears in the source material
‚ñ° If uncertain about ANY fact, SKIP that question
‚ñ° If material doesn't clearly state something, DON'T ask about it

CRITICAL CONSTRAINT: Students will NOT have access to any visual elements during the exam

Generate exactly 15 questions following this JSON format:

{
  "questions": [
    {
      "id": 1,
      "type": "multiple_choice",
      "question": "[Question about SPECIFIC content - in SAME language as source material]",
      "options": [
        "[Option A in source language]",
        "[Option B in source language]",
        "[Option C in source language]",
        "[Option D in source language]"
      ],
      "correct_answer": "[Exact match from options - in source language]",
      "explanation": "[1-2 sentence explanation in SAME language as source material]"
    }
  ],
  "summary": {
    "introduction": "[100-250 word introduction to the SPECIFIC topic in the SAME language as source material]",
    "key_concepts": "[250-500 word explanation focusing on the MAIN NARRATIVE in the SAME language]",
    "examples_and_applications": "[200-400 word section on understanding this historical topic in the SAME language]",
    "summary_conclusion": "[100-250 word conclusion in the SAME language]",
    "total_word_count": [approximate word count],
    "language": "[ISO 639-1 code - e.g., 'fi' for Finnish, 'en' for English, 'sv' for Swedish]"
  }
}

SUMMARY REQUIREMENTS:
- Write in the SAME language as the source material
- Target audience: Grade 5 students
- Total length: ~1000 words
- Structure: 4 sections as specified in the JSON format
- Educational tone: clear, pedagogical, age-appropriate
- Focus on the SPECIFIC historical topic from the material (not generic history concepts)
- Use proper formatting: **bold** for key terms, numbered lists where appropriate

CRITICAL - LANGUAGE DETECTION:
1. Examine the textbook images carefully
2. Identify the source language (Finnish, Swedish, English, German, etc.)
3. Generate ALL content in that detected language
4. Common patterns to help detect:
   - Finnish: "Suomen sis√§llissota", "vuonna", "punaisten", "valkoisten"
   - Swedish: "finska inb√∂rdeskriget", "√•r", "r√∂da", "vita"
   - English: "civil war", "year", "reds", "whites"
   - German: "B√ºrgerkrieg", "Jahr", "Roten", "Wei√üen"

QUALITY CHECKLIST (verify before finalizing):
‚ñ° At least 60% of questions focus on main events, causes, or key figures
‚ñ° Generic definition questions are < 20% of total
‚ñ° All facts are present in the source material
‚ñ° All dates, names, events verified for accuracy
‚ñ° Questions follow logical progression through the topic
‚ñ° No references to images, pages, or visual elements
‚ñ° Summary focuses on the specific topic (not generic history concepts)
‚ñ° ALL questions are in the SAME language as the source material
‚ñ° ALL options are in the SAME language as the source material
‚ñ° ALL explanations are in the SAME language as the source material
‚ñ° Summary sections are in the SAME language as the source material

IMPORTANT:
- The correct_answer field must contain the exact text from the options array
- The summary must be in the SAME language as the questions and source material
- Do not reference visual elements in the summary either

Begin analysis and question generation now.
=== END PROMPT ===
Prompt length: 6152 characters
Starting Gemini processing...
‚è±Ô∏è  [TIMER] Gemini processing started with prompt length: 6152 chars
‚è±Ô∏è  [TIMER] Gemini processing completed: 158782ms
‚è±Ô∏è  [TIMER] Gemini tokens - Input: 1751, Output: 65536, Cost: $0.026389
=== ATTEMPTING TO CREATE EXAMGENIE EXAM ===
Raw text length: 208148
Raw text preview: ```json
{
  "questions": [
    {
      "id": 1,
      "type": "multiple_choice",
      "question": "Mit√§ tapahtui pian Suomen itsen√§istymisen j√§lkeen?",
      "options": [
        "Suomeen perustettii
‚è±Ô∏è  [TIMER] Starting ExamGenie Exam Creation
üíæ Saved repaired JSON to debug-repaired.txt for inspection
Failed to parse Gemini JSON response: Failed to parse JSON after trying all strategies. Original text length: 208148
Parse method attempted: failed
Response preview: ```json
{
  "questions": [
    {
      "id": 1,
      "type": "multiple_choice",
      "question": "Mit√§ tapahtui pian Suomen itsen√§istymisen j√§lkeen?",
      "options": [
        "Suomeen perustettiin uusi kuningaskunta.",
        "Suomessa syttyi sis√§llissota.",
        "Suomi liittyi osaksi Ven√§j√§√§.",
        "Suomi julistautui osaksi Ruotsia."
      ],
      "correct_answer": "Suomessa syttyi sis√§llissota.",
      "explanation": "Tekstin mukaan pian Suomen itsen√§istymisen j√§lkeen Suomessa sy
‚è±Ô∏è  [TIMER] Starting File Cleanup
Cleaned up 1 files
‚è±Ô∏è  [TIMER] File Cleanup completed: 1ms
‚è±Ô∏è  [TIMER] === EXAMGENIE MOBILE API PROCESSING COMPLETED: 158791ms ===
‚è±Ô∏è  [TIMER] Performance breakdown:
‚è±Ô∏è  [TIMER] - File Processing: 2ms (0%)
‚è±Ô∏è  [TIMER] - File Cleanup: 1ms (0%)
‚è±Ô∏è  [TIMER] Metadata: imageCount: 1, promptType: default, geminiProcessingTime: 158782, examCreated: false
[RequestLogger] Initialized (enabled: true)
 POST /api/mobile/exam-questions 200 in 158813ms
[RequestLogger] Failed to insert log: Invalid API key
[?25h
